#include "codepage.h"
#include "dbg.h"
#include "env.h"
#include <stdlib.h>
#include <string.h>
#include <iconv.h>

#ifndef ICONV_UCS2BE_NAME
#define ICONV_UCS2BE_NAME "UCS-2BE"
#endif

/* List of code-pages */
struct cp_data
{
    const char *names;
    const uint16_t table[256];
    const uint8_t dbcs[8];
    const char *iconv_name;
};

static const struct cp_data cp_data[] = {
    {
        "437,CP437,IBM437,US",
        {
            0x0020, 0x263a, 0x263b, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
            0x25d8, 0x25cb, 0x25d9, 0x2642, 0x2640, 0x266a, 0x266b, 0x263c,
            0x25b6, 0x25c0, 0x2195, 0x203c, 0x00b6, 0x00a7, 0x25ac, 0x21a8,
            0x2191, 0x2193, 0x2192, 0x2190, 0x221f, 0x2194, 0x25b2, 0x25bc,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x00c7, 0x00fc, 0x00e9, 0x00e2, 0x00e4, 0x00e0, 0x00e5, 0x00e7,
            0x00ea, 0x00eb, 0x00e8, 0x00ef, 0x00ee, 0x00ec, 0x00c4, 0x00c5,
            0x00c9, 0x00e6, 0x00c6, 0x00f4, 0x00f6, 0x00f2, 0x00fb, 0x00f9,
            0x00ff, 0x00d6, 0x00dc, 0x00a2, 0x00a3, 0x00a5, 0x20a7, 0x0192,
            0x00e1, 0x00ed, 0x00f3, 0x00fa, 0x00f1, 0x00d1, 0x00aa, 0x00ba,
            0x00bf, 0x2310, 0x00ac, 0x00bd, 0x00bc, 0x00a1, 0x00ab, 0x00bb,
            0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556,
            0x2555, 0x2563, 0x2551, 0x2557, 0x255d, 0x255c, 0x255b, 0x2510,
            0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x255e, 0x255f,
            0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x2567,
            0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256b,
            0x256a, 0x2518, 0x250c, 0x2588, 0x2584, 0x258c, 0x2590, 0x2580,
            0x03b1, 0x00df, 0x0393, 0x03c0, 0x03a3, 0x03c3, 0x00b5, 0x03c4,
            0x03a6, 0x0398, 0x03a9, 0x03b4, 0x221e, 0x03c6, 0x03b5, 0x2229,
            0x2261, 0x00b1, 0x2265, 0x2264, 0x2320, 0x2321, 0x00f7, 0x2248,
            0x00b0, 0x2219, 0x00b7, 0x221a, 0x207f, 0x00b2, 0x25a0, 0x00a0},
        { 0, 0, 0, 0, 0, 0, 0, 0}, NULL
    },
    {
        "850,CP850,IBM850,Latin1,WEU",
        {
            0x0020, 0x263a, 0x263b, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
            0x25d8, 0x25cb, 0x25d9, 0x2642, 0x2640, 0x266a, 0x266b, 0x263c,
            0x25b6, 0x25c0, 0x2195, 0x203c, 0x00b6, 0x00a7, 0x25ac, 0x21a8,
            0x2191, 0x2193, 0x2192, 0x2190, 0x221f, 0x2194, 0x25b2, 0x25bc,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x00c7, 0x00fc, 0x00e9, 0x00e2, 0x00e4, 0x00e0, 0x00e5, 0x00e7,
            0x00ea, 0x00eb, 0x00e8, 0x00ef, 0x00ee, 0x00ec, 0x00c4, 0x00c5,
            0x00c9, 0x00e6, 0x00c6, 0x00f4, 0x00f6, 0x00f2, 0x00fb, 0x00f9,
            0x00ff, 0x00d6, 0x00dc, 0x00f8, 0x00a3, 0x00d8, 0x00d7, 0x0192,
            0x00e1, 0x00ed, 0x00f3, 0x00fa, 0x00f1, 0x00d1, 0x00aa, 0x00ba,
            0x00bf, 0x00ae, 0x00ac, 0x00bd, 0x00bc, 0x00a1, 0x00ab, 0x00bb,
            0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x00c1, 0x00c2, 0x00c0,
            0x00a9, 0x2563, 0x2551, 0x2557, 0x255d, 0x00a2, 0x00a5, 0x2510,
            0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x00e3, 0x00c3,
            0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x00a4,
            0x00f0, 0x00d0, 0x00ca, 0x00cb, 0x00c8, 0x0131, 0x00cd, 0x00ce,
            0x00cf, 0x2518, 0x250c, 0x2588, 0x2584, 0x00a6, 0x00cc, 0x2580,
            0x00d3, 0x00df, 0x00d4, 0x00d2, 0x00f5, 0x00d5, 0x00b5, 0x00fe,
            0x00de, 0x00da, 0x00db, 0x00d9, 0x00fd, 0x00dd, 0x00af, 0x00b4,
            0x00ad, 0x00b1, 0x2017, 0x00be, 0x00b6, 0x00a7, 0x00f7, 0x00b8,
            0x00b0, 0x00a8, 0x00b7, 0x00b9, 0x00b3, 0x00b2, 0x25a0, 0x00a0},
        { 0, 0, 0, 0, 0, 0, 0, 0}, NULL
    },
    {
        "852,CP850,IBM852,Latin2,CEU",
        {
            0x0020, 0x263a, 0x263b, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
            0x25d8, 0x25cb, 0x25d9, 0x2642, 0x2640, 0x266a, 0x266b, 0x263c,
            0x25b6, 0x25c0, 0x2195, 0x203c, 0x00b6, 0x00a7, 0x25ac, 0x21a8,
            0x2191, 0x2193, 0x2192, 0x2190, 0x221f, 0x2194, 0x25b2, 0x25bc,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x00c7, 0x00fc, 0x00e9, 0x00e2, 0x00e4, 0x016f, 0x0107, 0x00e7,
            0x0142, 0x00eb, 0x0150, 0x0151, 0x00ee, 0x0179, 0x00c4, 0x0106,
            0x00c9, 0x0139, 0x013a, 0x00f4, 0x00f6, 0x013d, 0x013e, 0x015a,
            0x015b, 0x00d6, 0x00dc, 0x0164, 0x0165, 0x0141, 0x00d7, 0x010d,
            0x00e1, 0x00ed, 0x00f3, 0x00fa, 0x0104, 0x0105, 0x017d, 0x017e,
            0x0118, 0x0119, 0x00ac, 0x017a, 0x010c, 0x015f, 0x00ab, 0x00bb,
            0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x00c1, 0x00c2, 0x011a,
            0x015e, 0x2563, 0x2551, 0x2557, 0x255d, 0x017b, 0x017c, 0x2510,
            0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x0102, 0x0103,
            0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x00a4,
            0x0111, 0x0110, 0x010e, 0x00cb, 0x010f, 0x0147, 0x00cd, 0x00ce,
            0x011b, 0x2518, 0x250c, 0x2588, 0x2584, 0x0162, 0x016e, 0x2580,
            0x00d3, 0x00df, 0x00d4, 0x0143, 0x0144, 0x0148, 0x0160, 0x0161,
            0x0154, 0x00da, 0x0155, 0x0170, 0x00fd, 0x00dd, 0x0163, 0x00b4,
            0x00ad, 0x02dd, 0x02db, 0x02c7, 0x02d8, 0x00a7, 0x00f7, 0x00b8,
            0x00b0, 0x00a8, 0x02d9, 0x0171, 0x0158, 0x0159, 0x25a0, 0x00a0},
        { 0, 0, 0, 0, 0, 0, 0, 0}, NULL
    },
    {
        "Kamenick√Ω,KEYBCS2,KAMENICKY,Czech,CZ,SK",
        {
            0x0020, 0x263a, 0x263b, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
            0x25d8, 0x25cb, 0x25d9, 0x2642, 0x2640, 0x266a, 0x266b, 0x263c,
            0x25b6, 0x25c0, 0x2195, 0x203c, 0x00b6, 0x00a7, 0x25ac, 0x21a8,
            0x2191, 0x2193, 0x2192, 0x2190, 0x221f, 0x2194, 0x25b2, 0x25bc,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x010c, 0x00fc, 0x00e9, 0x010f, 0x00e4, 0x010e, 0x0164, 0x010d,
            0x011b, 0x011a, 0x0139, 0x00cd, 0x013e, 0x013a, 0x00c4, 0x00c1,
            0x00c9, 0x017e, 0x017d, 0x00f4, 0x00f6, 0x00d3, 0x016f, 0x00da,
            0x00fd, 0x00d6, 0x00dc, 0x0160, 0x013d, 0x00dd, 0x0158, 0x0165,
            0x00e1, 0x00ed, 0x00f3, 0x00fa, 0x0148, 0x0147, 0x016e, 0x00d4,
            0x0161, 0x0159, 0x0155, 0x0154, 0x00bc, 0x00a7, 0x00ab, 0x00bb,
            0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556,
            0x2555, 0x2563, 0x2551, 0x2557, 0x255d, 0x255c, 0x255b, 0x2510,
            0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x255e, 0x255f,
            0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x2567,
            0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256b,
            0x256a, 0x2518, 0x250c, 0x2588, 0x2584, 0x258c, 0x2590, 0x2580,
            0x03b1, 0x03b2, 0x0393, 0x03c0, 0x03a3, 0x03c3, 0x03bc, 0x03c4,
            0x03a6, 0x0398, 0x03a9, 0x03b4, 0x221e, 0x2205, 0x03b5, 0x2229,
            0x2261, 0x00b1, 0x2265, 0x2264, 0x2320, 0x2321, 0x00f7, 0x2248,
            0x2218, 0x00b7, 0x2219, 0x221a, 0x207f, 0x00b2, 0x25a0, 0x00a0},
        { 0, 0, 0, 0, 0, 0, 0, 0}, NULL
    },
    {
        "866,CP866,IBM866,RU",
        {
            0x0020, 0x263a, 0x263b, 0x2665, 0x2666, 0x2663, 0x2660, 0x2022,
            0x25d8, 0x25cb, 0x25d9, 0x2642, 0x2640, 0x266a, 0x266b, 0x263c,
            0x25b6, 0x25c0, 0x2195, 0x203c, 0x00b6, 0x00a7, 0x25ac, 0x21a8,
            0x2191, 0x2193, 0x2192, 0x2190, 0x221f, 0x2194, 0x25b2, 0x25bc,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x0410, 0x0411, 0x0412, 0x0413, 0x0414, 0x0415, 0x0416, 0x0417,
            0x0418, 0x0419, 0x041a, 0x041b, 0x041c, 0x041d, 0x041e, 0x041f,
            0x0420, 0x0421, 0x0422, 0x0423, 0x0424, 0x0425, 0x0426, 0x0427,
            0x0428, 0x0429, 0x042a, 0x042b, 0x042c, 0x042d, 0x042e, 0x042f,
            0x0430, 0x0431, 0x0432, 0x0433, 0x0434, 0x0435, 0x0436, 0x0437,
            0x0438, 0x0439, 0x043a, 0x043b, 0x043c, 0x043d, 0x043e, 0x043f,
            0x2591, 0x2592, 0x2593, 0x2502, 0x2524, 0x2561, 0x2562, 0x2556,
            0x2555, 0x2563, 0x2551, 0x2557, 0x255d, 0x255c, 0x255b, 0x2510,
            0x2514, 0x2534, 0x252c, 0x251c, 0x2500, 0x253c, 0x255e, 0x255f,
            0x255a, 0x2554, 0x2569, 0x2566, 0x2560, 0x2550, 0x256c, 0x2567,
            0x2568, 0x2564, 0x2565, 0x2559, 0x2558, 0x2552, 0x2553, 0x256b,
            0x256a, 0x2518, 0x250c, 0x2588, 0x2584, 0x258c, 0x2590, 0x2580,
            0x0440, 0x0441, 0x0442, 0x0443, 0x0444, 0x0445, 0x0446, 0x0447,
            0x0448, 0x0449, 0x044a, 0x044b, 0x044c, 0x044d, 0x044e, 0x044f,
            0x0401, 0x0451, 0x0404, 0x0454, 0x0407, 0x0457, 0x040e, 0x045e,
            0x00B0, 0x2219, 0x00B7, 0x221A, 0x2116, 0x00A4, 0x25A0, 0x00A0},
        { 0, 0, 0, 0, 0, 0, 0, 0}, NULL
    },

    {
        "932,CP932,IBM932,Japanese,ShiftJIS",
        {
            //0x0020, 0x2554, 0x2557, 0x255a, 0x255d, 0x2551, 0x2550, 0xffec,
            //0x0020, 0xffee, 0x0020, 0x303f, 0x0020, 0x0020, 0xffed, 0x263c,
            0x0020, 0x002b, 0x002b, 0x002b, 0x002b, 0xffe8, 0x2012, 0xffec,
            0x0020, 0xffee, 0x0020, 0x303f, 0x0020, 0x0020, 0xffed, 0x263c,
            //0x256c, 0x0020, 0x21d5, 0x0020, 0x2591, 0x2569, 0x2566, 0x2563,
            //0x0020, 0x2560, 0x2592, 0x21b2, 0xffea, 0xffe8, 0xffeb, 0xffe9,
            0x002b, 0x0020, 0x21d5, 0x0020, 0x2591, 0x002b, 0x002b, 0x002b,
            0x0020, 0x002b, 0x2591, 0x21b2, 0xffea, 0xffe8, 0xffeb, 0xffe9,
            0x0020, 0x0021, 0x0022, 0x0023, 0x0024, 0x0025, 0x0026, 0x0027,
            0x0028, 0x0029, 0x002a, 0x002b, 0x002c, 0x002d, 0x002e, 0x002f,
            0x0030, 0x0031, 0x0032, 0x0033, 0x0034, 0x0035, 0x0036, 0x0037,
            0x0038, 0x0039, 0x003a, 0x003b, 0x003c, 0x003d, 0x003e, 0x003f,
            0x0040, 0x0041, 0x0042, 0x0043, 0x0044, 0x0045, 0x0046, 0x0047,
            0x0048, 0x0049, 0x004a, 0x004b, 0x004c, 0x004d, 0x004e, 0x004f,
            0x0050, 0x0051, 0x0052, 0x0053, 0x0054, 0x0055, 0x0056, 0x0057,
            0x0058, 0x0059, 0x005a, 0x005b, 0x005c, 0x005d, 0x005e, 0x005f,
            0x0060, 0x0061, 0x0062, 0x0063, 0x0064, 0x0065, 0x0066, 0x0067,
            0x0068, 0x0069, 0x006a, 0x006b, 0x006c, 0x006d, 0x006e, 0x006f,
            0x0070, 0x0071, 0x0072, 0x0073, 0x0074, 0x0075, 0x0076, 0x0077,
            0x0078, 0x0079, 0x007a, 0x007b, 0x007c, 0x007d, 0x007e, 0x2302,

            0x00c7, 0x0081, 0x0082, 0x0083, 0x0084, 0x0085, 0x0086, 0x0087,
            0x0088, 0x0089, 0x008a, 0x008b, 0x008c, 0x008d, 0x008e, 0x008f,
            0x0090, 0x0091, 0x0092, 0x0093, 0x0094, 0x0095, 0x0096, 0x0097,
            0x0098, 0x0099, 0x009a, 0x009b, 0x009c, 0x009d, 0x009e, 0x009f,
            0x0020, 0xff61, 0xff62, 0xff63, 0xff64, 0xff65, 0xff66, 0xff67,
            0xff68, 0xff69, 0xff6a, 0xff6b, 0xff6c, 0xff6d, 0xff6e, 0xff6f,
            0xff70, 0xff71, 0xff72, 0xff73, 0xff74, 0xff75, 0xff76, 0xff77,
            0xff78, 0xff79, 0xff7a, 0xff7b, 0xff7c, 0xff7d, 0xff7e, 0xff7f,
            0xff80, 0xff81, 0xff82, 0xff83, 0xff84, 0xff85, 0xff86, 0xff87,
            0xff88, 0xff89, 0xff8a, 0xff8b, 0xff8c, 0xff8d, 0xff8e, 0xff8f,
            0xff90, 0xff91, 0xff92, 0xff93, 0xff94, 0xff95, 0xff96, 0xff97,
            0xff98, 0xff99, 0xff9a, 0xff9b, 0xff9c, 0xff9d, 0xff9e, 0xff9f,
            0x00e0, 0x00e1, 0x00e2, 0x00e3, 0x00e4, 0x00e5, 0x00e6, 0x00e7,
            0x00e8, 0x00e9, 0x00ea, 0x00eb, 0x00ec, 0x00ed, 0x00ee, 0x00ef,
            0x00f0, 0x00f1, 0x00f2, 0x00f3, 0x00f4, 0x00f5, 0x00f6, 0x00f7,
            0x00f8, 0x00f9, 0x00fa, 0x00fb, 0x00fc, 0x00fd, 0x00fe, 0x00ff},
        { 0x81, 0x9F, 0xE0, 0xFC, 0, 0, 0, 0 }, "CP932,MS_KANJI,SHIFT_JIS,SJIS"
    },

    {
        0
    }
};

static const uint16_t *cp_table = cp_data[0].table;
const uint8_t *cp_dbcs = cp_data[0].dbcs;
static const char *cp_iconv_name = NULL;
static uint8_t dbcs_prev_char = 0;
static iconv_t cp_iconv_input = (iconv_t)(-1);
static iconv_t cp_iconv_output = (iconv_t)(-1);

static void set_codepage_iconv() {
    if (cp_iconv_name) {
        char *names = strdup(cp_iconv_name);
        char *name = strtok(names, ",");
        for(; name; name = strtok(0, ","))
        {
            cp_iconv_input =
                iconv_open(name, ICONV_UCS2BE_NAME);
            cp_iconv_output =
                iconv_open(ICONV_UCS2BE_NAME, name);
            if (cp_iconv_input != (iconv_t)(-1) &&
                cp_iconv_output != (iconv_t)(-1))
                break;
            if (cp_iconv_input != (iconv_t)(-1))
                iconv_close(cp_iconv_input);
            if (cp_iconv_output != (iconv_t)(-1))
                iconv_close(cp_iconv_output);
            cp_iconv_input = (iconv_t)(-1);
            cp_iconv_output = (iconv_t)(-1);
        }
        free(names);
        debug(debug_dos, "set_codepage_iconv '%s'<->'%s'\n",
              ICONV_UCS2BE_NAME, name ? name : "(NULL)");
    }
    dbcs_prev_char = 0;
}

static int read_codepage_file(const char *fname)
{
    FILE *f = fopen(fname, "r");
    if(!f)
        return 0;
    // Note: this leaks memory, so this function should be called only once.
    uint16_t *new_table = malloc(sizeof(cp_table[0]) * 256);
    uint8_t *new_dbcs = malloc(sizeof(cp_dbcs[0]) * 8);
    char *new_iconv = NULL;
    if(!new_table || !new_dbcs)
    {
        fclose(f);
        return 0;
    }
    // Start with a copy of CP437
    memcpy(new_table, cp_data[0].table, sizeof(cp_table[0]) * 256);
    memcpy(new_dbcs, cp_data[0].dbcs, sizeof(cp_dbcs[0]) * 8);
    // Read all lines in file
    while(!feof(f))
    {
        char line[256];
        int dcode = 0, ucode = 0;
        if(1 != fscanf(f, " %255[^\n\r#]%*[^\n\r]\n", line))
        {
            // Try to consume comments
            if(EOF == fscanf(f, "%*[^\n\r]\n"))
                break;
            continue;
        }

        if(line[0] == '#')
            continue;
        if(strncmp(line, "dbcs:", 5) == 0)
        {
            int dbcs[8];
            sscanf(line+5, "%x %x %x %x %x %x %x %x",
                   dbcs, dbcs+1, dbcs+2, dbcs+3,
                   dbcs+4, dbcs+5, dbcs+6, dbcs+7);
            for (int i = 0; i < 8; i++)
                new_dbcs[i] = dbcs[i] & 0xff;
            continue;
        }
        if(strncmp(line, "iconv:", 5) == 0)
        {
            char iconv_name[512];
            sscanf(line+6, "%s", iconv_name);
            new_iconv = strdup(iconv_name);
            continue;
        }
        if(2 == sscanf(line, "%i %i", &dcode, &ucode))
        {
            if(dcode < 0 || dcode > 256)
            {
                fclose(f);
                free(new_table);
                print_error("reading codepage '%s', line '%s', invalid byte value %d\n",
                            fname, line, dcode);
            }
            // Ignore control-codes
            if(dcode < 32 || dcode == 127)
                continue;
            if(ucode < 32 || ucode > 0xFFFF)
            {
                fclose(f);
                free(new_table);
                print_error(
                    "reading codepage '%s', line '%s', invalid unicode value %d\n", fname,
                    line, ucode);
            }
            new_table[dcode] = ucode;
        }
    }
    fclose(f);
    cp_table = new_table;
    cp_dbcs = new_dbcs;
    cp_iconv_name = new_iconv;
    set_codepage_iconv();
    return 1;
}

void set_codepage(const char *cp_name)
{
    // Search our list of codepages
    for(const struct cp_data *cp = cp_data; cp->names; cp++)
    {
        char *names = strdup(cp->names);
        for(char *name = strtok(names, ","); name; name = strtok(0, ","))
        {
            if(0 == strcasecmp(cp_name, name))
            {
                debug(debug_dos, "set_codepage: DOS CP set to '%s'\n", names);
                cp_table = cp->table;
                cp_dbcs = cp->dbcs;
                cp_iconv_name = cp->iconv_name;
                set_codepage_iconv();
                return;
            }
        }
        free(names);
    }
    if(!read_codepage_file(cp_name))
        print_error("missing or unknown codepage '%s', use '?' for a list.\n", cp_name);
}

static void list_codepages(void)
{
    fprintf(stderr, "List of internal codepages:\n");
    for(const struct cp_data *cp = cp_data; cp->names; cp++)
        fprintf(stderr, "\t%s\n", cp->names);
    print_error("select one of the above or a filename with a translation table.\n");
}

void init_codepage(void)
{
    const char *cp = getenv(ENV_CODEPAGE);
    if(cp && *cp)
    {
        if(!strcmp(cp, "?"))
            list_codepages();
        set_codepage(cp);
    }
}

int check_dbcs_1st(uint8_t cp)
{
    for (int i = 0; i < 4; i++) {
        uint8_t lo = cp_dbcs[i*2];
        uint8_t hi = cp_dbcs[i*2 + 1];
        if (lo == 0 && hi == 0)
            break;
        if (lo <= cp && cp <= hi)
            return 1;
    }
    return 0;
}

/* Transforms a DOS char to Unicode */
int get_unicode(uint8_t cp, int *dbcs)
{
    if (dbcs_prev_char) {
        uint8_t inbuf[2];
        uint8_t outbuf[2];
        char *src, *dst;
        size_t srclen, dstlen;
        int s;

        src = (char *)inbuf;
        srclen = sizeof(inbuf);
        dst = (char *)outbuf;
        dstlen = sizeof(outbuf);

        inbuf[0] = dbcs_prev_char;
        inbuf[1] = cp;
        dbcs_prev_char = 0;
        s = iconv(cp_iconv_output, &src, &srclen, &dst, &dstlen);
        if (s == (size_t)-1)
            return 0;
        if (dbcs)
            *dbcs = 1;
        if (sizeof(outbuf) - dstlen == 1)
            return outbuf[0];
        return (outbuf[0] << 8) | outbuf[1];
    }
    else if (check_dbcs_1st(cp)) {
        dbcs_prev_char = cp;
        if (dbcs)
            *dbcs = 0;
        return 0;
    }
    if (dbcs)
        *dbcs = 0;
    return cp_table[cp];
}

/* Transforms a Unicode code-point to the DOS char */
int get_dos_char(int uc, int *c1, int *c2)
{
    uint8_t inbuf[2];
    uint8_t outbuf[2];
    char *src, *dst;
    size_t srclen, dstlen;
    int s;

    // TODO: faster searching
    for (int i = 0; i < 256; i++) {
        if(uc == cp_table[i]) {
            *c1 = i;
            return 1;
        }
    }
    src = (char *)inbuf;
    srclen = sizeof(inbuf);
    dst = (char *)outbuf;
    dstlen = sizeof(outbuf);
    inbuf[0] = (uc >> 8) & 0xff;
    inbuf[1] = uc & 0xff;
    s = iconv(cp_iconv_input, &src, &srclen, &dst, &dstlen);
    if (s != (size_t)-1) {
        *c1 = outbuf[0] & 0xFF;
        *c2 = outbuf[1] & 0xFF;
        return sizeof(outbuf) - dstlen;
    }
    // Assume space is always valid
    *c1 = ' ';
    return 1;
}

int utf8_to_unicode(uint8_t **p)
{
    int unicode = 0;
    uint8_t *u = *p;

    if (u[0] < 0x80)
        unicode = *u++;
    else if (u[0] < 0xE0) {
        if(!u[1])
            u++;
        else {
            unicode = (((uint16_t)u[0] & 0x1F) << 6) |
                      (           u[1] & 0x3F);
            u += 2;
        }
    }
    else if (u[0] < 0xf0) {
        if(!u[1] || !u[2]) {
            while (*u)
                u++;
        }
        unicode = (((uint16_t)u[0] & 0x0F) << 12)|
                  (((uint16_t)u[1] & 0x3F) << 6) |
                  (           u[2] & 0x3F);
        u += 3;
    }
    else {
        for (int i=0; i<4 && *u; u++)
            /*NOP*/;
    }
    *p = u;
    return unicode;
}

void unicode_to_utf8(uint8_t **dst, int uc)
{
    uint8_t *d = *dst;
    if(uc < 128)
        *d++ = uc;
    else if(uc < 0x800) {
        *d++ = 0xC0 | (uc >> 6);
        *d++ = 0x80 | (uc & 0x3F);
    }
    else if(uc < 0x10000) {
        *d++ = 0xE0 | (uc >> 12);
        *d++ = 0x80 | ((uc >> 6) & 0x3F);
        *d++ = 0x80 | (uc & 0x3F);
    }
    *dst = d;
}
